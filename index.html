<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a"> <!-- Slate-900 -->
    <title>Mimi TV</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #020617; /* Slate-950 */
        color: #e2e8f0; /* Slate-200 */
        overflow: hidden; 
      }
      /* 自定义深色滚动条 */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a; 
      }
      ::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569; 
      }
      /* 工具类 */
      .no-scrollbar::-webkit-scrollbar {
          display: none;
      }
      .no-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      .glass-panel {
          background: rgba(15, 23, 42, 0.95);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
      }
    </style>

    <!-- Import Map: 统一使用 React 18 避免版本冲突 -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "hls.js": "https://esm.sh/hls.js@1.4.10"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Search, Tv, Filter, Wifi, WifiOff, CheckCircle2, RotateCw, 
            Settings, Link as LinkIcon, X, Star, ShieldAlert, Copy, Check, 
            Menu, Loader2, RefreshCw, Volume2, VolumeX, Maximize2, AlertCircle,
            Plus, Trash2, Power, Edit2, Layers, Play, Pause
        } from 'lucide-react';
        import Hls from 'hls.js';

        // --- 1. 服务与解析逻辑 (Services) ---

        // 简单的哈希函数，用于生成 ID
        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; 
            }
            return `gen-${Math.abs(hash)}`;
        };

        // 解析 .txt 格式 (频道名,URL 或 #genre#分类)
        const parseTXT = (content) => {
            const lines = content.split('\n');
            const channels = [];
            let currentGroup = '未分类';
            
            for(const line of lines) {
                const trimmed = line.trim();
                if(!trimmed) continue;
                
                // 处理分组: "#genre#CCTV" 或 "CCTV,#genre#"
                if(trimmed.includes('#genre#')) {
                    const parts = trimmed.split(',');
                    if(parts.length > 0) {
                        // 通常是 "GroupName,#genre#" 或 "#genre#,GroupName"
                        currentGroup = parts[0].includes('#genre#') ? parts[1] : parts[0];
                        if (!currentGroup) currentGroup = '未分类';
                        currentGroup = currentGroup.replace('#genre#', '').trim();
                    }
                    continue;
                }
                
                // 处理 "频道名,URL" 格式
                if(trimmed.includes(',')) {
                    const firstCommaIndex = trimmed.indexOf(',');
                    const name = trimmed.substring(0, firstCommaIndex).trim();
                    const url = trimmed.substring(firstCommaIndex + 1).trim();
                    
                    if(url && (url.startsWith('http') || url.startsWith('rtmp') || url.startsWith('rtsp'))) {
                         const id = `txt-${simpleHash(url)}`;
                         channels.push({
                             id,
                             name,
                             url,
                             group: currentGroup,
                             logo: undefined // TXT 格式通常没有 logo
                         });
                    }
                }
            }
            return channels;
        };

        // 解析 .m3u 格式
        const parseM3U = (content) => {
            const lines = content.split('\n');
            const channels = [];
            let currentChannel = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('#EXTINF:')) {
                    const infoMatch = line.match(/#EXTINF:(-?\d+)(.*),(.*)$/);
                    if (infoMatch) {
                        const attributes = infoMatch[2];
                        const name = infoMatch[3].trim();
                        const groupMatch = attributes.match(/group-title="([^"]*)"/);
                        const group = groupMatch ? groupMatch[1] : '未分类';
                        const logoMatch = attributes.match(/tvg-logo="([^"]*)"/);
                        const logo = logoMatch ? logoMatch[1] : undefined;
                        const idMatch = attributes.match(/tvg-id="([^"]*)"/);
                        currentChannel = { name, group, logo, id: idMatch ? idMatch[1] : undefined };
                    }
                } else if (line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('rtsp')) {
                    if (line.length < 5) {
                        currentChannel = {};
                        continue;
                    }
                    if (currentChannel.name) {
                        const finalId = currentChannel.id || simpleHash(line);
                        channels.push({ ...currentChannel, id: finalId, url: line });
                        currentChannel = {}; 
                    }
                }
            }
            return channels;
        };

        // 统一获取并解析逻辑
        const fetchAndParsePlaylist = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`无法获取播放列表: ${response.statusText}`);
                const text = await response.text();
                
                // 自动检测格式
                if (text.trim().startsWith('#EXTM3U') || text.includes('#EXTINF:')) {
                    return parseM3U(text);
                } else {
                    return parseTXT(text);
                }
            } catch (error) {
                console.error("播放列表获取错误:", error);
                throw error;
            }
        };

        const extractGroups = (channels) => {
            const groups = {};
            channels.forEach(ch => {
                const g = ch.group || '其他';
                groups[g] = (groups[g] || 0) + 1;
            });
            return Object.entries(groups)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
        };

        // --- 2. 视频播放器组件 (VideoPlayer) ---

        const VideoPlayer = ({ url, poster, channelName, onError, onSuccess }) => {
            const videoRef = useRef(null);
            const hlsRef = useRef(null);
            const [error, setError] = useState(null);
            const [isMixedContentError, setIsMixedContentError] = useState(false);
            const [loading, setLoading] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isMuted, setIsMuted] = useState(false);

            useEffect(() => {
                setError(null);
                setIsMixedContentError(false);
                setLoading(true);
                setIsPlaying(false);

                const video = videoRef.current;
                if (!video) return;

                if (!url) {
                    setLoading(false);
                    return;
                }

                const isPageHttps = window.location.protocol === 'https:';
                const isStreamHttp = url.startsWith('http:');
                const likelyMixedContent = isPageHttps && isStreamHttp;

                const loadStream = () => {
                    if (Hls.isSupported()) {
                        if (hlsRef.current) hlsRef.current.destroy();
                        const hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                        hlsRef.current = hls;
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            setLoading(false);
                            onSuccess?.();
                            video.play().catch(e => console.warn("自动播放被阻止", e));
                        });
                        hls.on(Hls.Events.ERROR, (event, data) => {
                            if (data.fatal) {
                                setLoading(false);
                                if (likelyMixedContent) {
                                    setIsMixedContentError(true);
                                    setError("安全错误: 混合内容");
                                    onError?.();
                                    hls.destroy();
                                    return;
                                }
                                setError("流媒体错误");
                                onError?.();
                                hls.destroy();
                            }
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = url;
                        video.addEventListener('loadedmetadata', () => {
                            setLoading(false);
                            onSuccess?.();
                            video.play().catch(() => {});
                        });
                        video.addEventListener('error', () => {
                            setLoading(false);
                            setError("原生播放错误");
                            onError?.();
                        });
                    } else {
                        setLoading(false);
                        setError("浏览器不支持");
                        onError?.();
                    }
                };
                loadStream();
                return () => { if (hlsRef.current) hlsRef.current.destroy(); };
            }, [url]);

            const reloadStream = () => {
                if (url) {
                    setError(null);
                    setLoading(true);
                    if (hlsRef.current) {
                        hlsRef.current.loadSource(url);
                        hlsRef.current.attachMedia(videoRef.current);
                    } else if (videoRef.current) {
                        videoRef.current.src = url;
                    }
                }
            };

            const togglePlay = () => {
                if(videoRef.current) {
                    if(videoRef.current.paused) videoRef.current.play();
                    else videoRef.current.pause();
                }
            };

            // 占位符
            if (!url) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-black text-slate-600 relative overflow-hidden">
                        <div className="relative z-10 flex flex-col items-center opacity-40">
                            <Tv className="w-24 h-24 mb-4" strokeWidth={1} />
                            <h2 className="text-xl font-medium tracking-wide">请选择一个频道</h2>
                        </div>
                    </div>
                );
            }

            return (
                <div className="relative w-full h-full bg-black group overflow-hidden flex flex-col justify-center">
                    {loading && (
                        <div className="absolute inset-0 z-20 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="flex flex-col items-center">
                                <Loader2 className="w-10 h-10 text-blue-500 animate-spin" />
                            </div>
                        </div>
                    )}

                    {error && (
                        <div className="absolute inset-0 z-30 flex flex-col items-center justify-center bg-black/80 backdrop-blur text-slate-300 p-6 text-center">
                            <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 max-w-md shadow-2xl">
                                {isMixedContentError ? (
                                    <>
                                        <ShieldAlert className="w-12 h-12 text-yellow-500 mx-auto mb-3" />
                                        <h3 className="text-lg font-bold mb-2 text-white">安全拦截</h3>
                                        <p className="text-slate-400 text-sm mb-4">您的浏览器阻止了在 HTTPS 页面上播放 HTTP 视频流。</p>
                                    </>
                                ) : (
                                    <>
                                        <AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-3" />
                                        <h3 className="text-lg font-bold mb-2 text-white">播放出错</h3>
                                        <p className="text-slate-400 text-sm mb-4">{error}</p>
                                        <button onClick={reloadStream} className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors text-sm border border-slate-700">
                                            <RefreshCw className="w-4 h-4" /> 重试
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    <video
                        ref={videoRef}
                        className="w-full h-full object-contain"
                        poster={poster}
                        playsInline
                        onPlay={() => setIsPlaying(true)}
                        onPause={() => setIsPlaying(false)}
                        controlsList="nodownload"
                        onClick={togglePlay}
                    />
                    
                    {/* 控制栏 */}
                    <div className="absolute bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center gap-6 z-10 pointer-events-none">
                        <div className="pointer-events-auto flex items-center gap-6 w-full">
                            
                            {/* 频道信息 */}
                            <div className="flex-1 min-w-0">
                                <h2 className="text-white font-bold text-2xl drop-shadow-md truncate tracking-tight">{channelName || "未知频道"}</h2>
                                <div className="flex items-center gap-2 text-sm text-blue-400 font-medium mt-1">
                                   <span className="w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse"></span>
                                   LIVE STREAM
                                </div>
                            </div>

                            {/* 播放/暂停 */}
                            <button 
                                onClick={togglePlay} 
                                className="p-4 bg-white/10 hover:bg-white/20 text-white rounded-2xl transition-all backdrop-blur-md shadow-lg active:scale-95"
                                title={isPlaying ? "暂停" : "播放"}
                            >
                                {isPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" />}
                            </button>

                            {/* 静音/取消静音 */}
                            <button onClick={() => {if(videoRef.current) {videoRef.current.muted = !videoRef.current.muted; setIsMuted(videoRef.current.muted)}}} 
                                className="p-4 bg-white/10 hover:bg-white/20 text-white rounded-2xl transition-all backdrop-blur-md shadow-lg active:scale-95">
                                {isMuted ? <VolumeX size={32} /> : <Volume2 size={32} />}
                            </button>
                            
                            {/* 全屏 */}
                            <button onClick={() => {if(videoRef.current) {document.fullscreenElement ? document.exitFullscreen() : videoRef.current.requestFullscreen()}}} 
                                className="p-4 bg-white/10 hover:bg-white/20 text-white rounded-2xl transition-all backdrop-blur-md shadow-lg active:scale-95">
                                <Maximize2 size={32} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. 频道列表组件 (ChannelList) ---

        const ChannelList = ({ 
            channels, favorites, groups, selectedChannel, onSelectChannel, onToggleFavorite, 
            isOpen, setIsOpen, channelStatuses, onCheckConnectivity, isChecking, 
            playlists, onAddPlaylist, onRemovePlaylist, onTogglePlaylist 
        }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [activeGroup, setActiveGroup] = useState('All');
            const [hideOffline, setHideOffline] = useState(false);
            const [isSourceModalOpen, setIsSourceModalOpen] = useState(false);
            const [copiedId, setCopiedId] = useState(null);
            const [newSourceName, setNewSourceName] = useState('');
            const [newSourceUrl, setNewSourceUrl] = useState('');

            const isSecurePage = window.location.protocol === 'https:';

            useEffect(() => {
                if (favorites.length > 0) setActiveGroup('Favorites');
            }, []);

            const filteredChannels = useMemo(() => {
                let result = [];
                if (activeGroup === 'Favorites') result = favorites;
                else if (activeGroup === 'All') result = channels;
                else result = channels.filter(ch => ch.group === activeGroup);

                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    result = result.filter(ch => ch.name.toLowerCase().includes(lower));
                }
                if (hideOffline) {
                    result = result.filter(ch => channelStatuses[ch.id] !== 'offline');
                }
                return result;
            }, [channels, favorites, activeGroup, searchTerm, hideOffline, channelStatuses]);

            const [visibleCount, setVisibleCount] = useState(50);
            const handleScroll = (e) => {
                const { scrollTop, clientHeight, scrollHeight } = e.currentTarget;
                if (scrollHeight - scrollTop - clientHeight < 300) {
                    if (visibleCount < filteredChannels.length) setVisibleCount(prev => prev + 50);
                }
            };
            useMemo(() => setVisibleCount(50), [activeGroup, searchTerm, hideOffline]);

            const handleAddSource = (e) => {
                e.preventDefault();
                if (newSourceName.trim() && newSourceUrl.trim()) {
                    onAddPlaylist(newSourceName.trim(), newSourceUrl.trim());
                    setNewSourceName('');
                    setNewSourceUrl('');
                }
            };

            const handleCopy = (e, channel) => {
                e.stopPropagation();
                // 确保 ID 不包含前缀，如果只是普通复制
                const cleanId = channel.id.split('-').slice(1).join('-') || channel.id;
                
                const parts = [
                  `#EXTINF:-1`,
                  `tvg-id="${cleanId}"`,
                  `tvg-name="${channel.name}"`,
                  `tvg-logo="${channel.logo || ''}"`,
                  `group-title="${channel.group || ''}",${channel.name}`
                ];
                
                const m3uEntry = `${parts.join(' ')}\n${channel.url}`;

                navigator.clipboard.writeText(m3uEntry).then(() => {
                    setCopiedId(channel.id);
                    setTimeout(() => setCopiedId(null), 2000);
                });
            };

            const getStatusIcon = (status) => {
                switch(status) {
                    case 'online': return <CheckCircle2 className="w-3.5 h-3.5 text-emerald-500" />;
                    case 'offline': return <WifiOff className="w-3.5 h-3.5 text-slate-600" />;
                    case 'testing': return <RotateCw className="w-3.5 h-3.5 text-blue-500 animate-spin" />;
                    default: return <div className="w-2 h-2 rounded-full bg-slate-700" />;
                }
            };

            return (
                <>
                    {isOpen && (
                        <div className="fixed inset-0 bg-black/80 z-40 md:hidden" onClick={() => setIsOpen(false)} />
                    )}

                    {/* 直播源管理弹窗 */}
                    {isSourceModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[85vh]">
                                <button onClick={() => setIsSourceModalOpen(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors">
                                    <X size={20} />
                                </button>
                                
                                <div className="flex items-center gap-3 mb-6 shrink-0">
                                    <div className="p-3 bg-blue-900/30 rounded-lg border border-blue-900/50">
                                        <Layers className="w-6 h-6 text-blue-500" />
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-white">直播源管理</h3>
                                        <p className="text-xs text-slate-400">配置您的播放列表 (支持 .m3u, .txt)</p>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3 custom-scrollbar">
                                    {playlists.map(pl => (
                                        <div key={pl.id} className="flex items-center gap-3 p-3 bg-slate-950 border border-slate-800 rounded-lg group hover:border-slate-700 transition-colors">
                                            <button 
                                                onClick={() => onTogglePlaylist(pl.id)}
                                                className={`p-2 rounded-md transition-all ${pl.active ? 'bg-emerald-500/20 text-emerald-500' : 'bg-slate-800 text-slate-500'}`}
                                            >
                                                <Power size={18} />
                                            </button>
                                            
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <h4 className={`font-medium text-sm truncate ${pl.active ? 'text-slate-200' : 'text-slate-500'}`}>{pl.name}</h4>
                                                    {!pl.active && <span className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500">已禁用</span>}
                                                </div>
                                                <p className="text-xs text-slate-600 truncate font-mono">{pl.url}</p>
                                            </div>

                                            <button 
                                                onClick={() => onRemovePlaylist(pl.id)}
                                                className="p-2 text-slate-600 hover:text-red-400 hover:bg-slate-900 rounded-md transition-colors"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                <div className="shrink-0 bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                    <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1">
                                        <Plus size={14} /> 添加新源
                                    </h4>
                                    <form onSubmit={handleAddSource} className="flex flex-col gap-3">
                                        <input 
                                            type="text" 
                                            placeholder="源名称 (例如: 我的电视)"
                                            value={newSourceName}
                                            onChange={(e) => setNewSourceName(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                                            required
                                        />
                                        <input 
                                            type="url" 
                                            placeholder="URL (http://... 或 https://...)"
                                            value={newSourceUrl}
                                            onChange={(e) => setNewSourceUrl(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                                            required
                                        />
                                        <button 
                                            type="submit"
                                            className="w-full py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition-colors flex items-center justify-center gap-2"
                                        >
                                            添加直播源
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 侧边栏 */}
                    <div className={`
                        fixed md:relative inset-y-0 left-0 z-50 
                        w-[340px] glass-panel border-r border-slate-800 
                        flex flex-col transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none
                        ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
                    `}>
                        <div className="p-4 border-b border-slate-800 shrink-0 space-y-4 bg-slate-900">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                        <Tv className="text-white w-5 h-5" />
                                    </div>
                                    <h1 className="font-bold text-xl text-white tracking-tight">Mimi TV</h1>
                                </div>
                                
                                <button onClick={() => setIsSourceModalOpen(true)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-700" title="管理直播源">
                                    <Settings className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="relative group">
                                <Search className="absolute left-3 top-2.5 text-slate-500 w-4 h-4 group-focus-within:text-blue-500 transition-colors" />
                                <input 
                                    type="text" 
                                    placeholder="搜索频道..." 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full bg-slate-950 border border-slate-800 rounded-lg py-2 pl-9 pr-4 text-sm text-slate-200 placeholder-slate-600 focus:outline-none focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all"
                                />
                            </div>

                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => onCheckConnectivity(filteredChannels)}
                                    disabled={isChecking}
                                    className={`flex-1 flex items-center justify-center gap-2 py-1.5 rounded-md text-xs font-medium border transition-all ${
                                        isChecking 
                                        ? 'bg-slate-800 border-slate-700 text-slate-500 cursor-not-allowed'
                                        : 'bg-slate-800 border-slate-700 text-blue-400 hover:bg-slate-700 hover:border-slate-600 hover:text-blue-300'
                                    }`}
                                >
                                    {isChecking ? <RotateCw className="w-3.5 h-3.5 animate-spin" /> : <Wifi className="w-3.5 h-3.5" />}
                                    {isChecking ? '检测中...' : '检测有效性'}
                                </button>
                                
                                <button 
                                    onClick={() => setHideOffline(!hideOffline)}
                                    className={`px-3 py-1.5 rounded-md text-xs font-medium border transition-all ${
                                        hideOffline 
                                        ? 'bg-slate-700 border-slate-600 text-white' 
                                        : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700 hover:text-slate-200'
                                    }`}
                                >
                                    {hideOffline ? '仅显示有效' : '显示全部'}
                                </button>
                            </div>
                        </div>

                        {/* 分类标签 */}
                        <div className="px-4 py-3 border-b border-slate-800 flex gap-2 overflow-x-auto no-scrollbar shrink-0 bg-slate-900/50">
                            <button
                                onClick={() => setActiveGroup('Favorites')}
                                className={`whitespace-nowrap px-3 py-1 text-xs font-medium rounded-full transition-all flex items-center gap-1.5 ${
                                    activeGroup === 'Favorites' 
                                    ? 'bg-yellow-600/20 text-yellow-500 border border-yellow-600/50' 
                                    : 'bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700'
                                }`}
                            >
                                <Star className={`w-3 h-3 ${activeGroup === 'Favorites' ? 'fill-current' : ''}`} />
                                收藏
                            </button>

                            <button
                                onClick={() => setActiveGroup('All')}
                                className={`whitespace-nowrap px-3 py-1 text-xs font-medium rounded-full transition-all ${
                                    activeGroup === 'All' 
                                    ? 'bg-blue-600 text-white border border-blue-500' 
                                    : 'bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700'
                                }`}
                            >
                                全部
                            </button>

                            {groups.map(g => (
                                <button
                                    key={g.name}
                                    onClick={() => setActiveGroup(g.name)}
                                    className={`whitespace-nowrap px-3 py-1 text-xs font-medium rounded-full transition-all ${
                                        activeGroup === g.name
                                        ? 'bg-blue-600 text-white border border-blue-500' 
                                        : 'bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700'
                                    }`}
                                >
                                    {g.name}
                                </button>
                            ))}
                        </div>

                        {/* 频道列表 */}
                        <div 
                            className="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"
                            onScroll={handleScroll}
                        >
                            {filteredChannels.length === 0 ? (
                                <div className="flex flex-col items-center justify-center py-12 text-slate-600 px-4 text-center">
                                    <Filter className="w-8 h-8 mb-2 opacity-50" />
                                    <p className="text-sm">没有找到频道</p>
                                    
                                    {isSecurePage && hideOffline && (
                                        <div className="mt-4 p-3 bg-slate-800/50 border border-slate-700 rounded-lg text-xs text-left max-w-[240px]">
                                            <div className="flex items-center gap-2 mb-1 text-yellow-500 font-bold">
                                                <ShieldAlert size={14} />
                                                <span>HTTPS 问题</span>
                                            </div>
                                            <p className="text-slate-400 mb-2 leading-relaxed">
                                                浏览器安全策略可能隐藏了 HTTP 频道。
                                            </p>
                                            <button 
                                                onClick={() => setHideOffline(false)}
                                                className="w-full py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-slate-200 transition-colors border border-slate-600"
                                            >
                                                强制显示全部
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                filteredChannels.slice(0, visibleCount).map((channel, index) => {
                                    const status = channelStatuses[channel.id] || 'unknown';
                                    const isOffline = status === 'offline';
                                    const isFavorite = favorites.some(f => f.url === channel.url);
                                    const isSelected = selectedChannel?.url === channel.url;

                                    return (
                                        <div 
                                            key={`${channel.id}-${index}`}
                                            onClick={() => {
                                                onSelectChannel(channel);
                                                if (window.innerWidth < 768) setIsOpen(false); 
                                            }}
                                            className={`w-full p-2.5 rounded-lg flex items-center gap-3 transition-all group relative cursor-pointer border ${
                                                isSelected 
                                                ? 'bg-blue-600/10 border-blue-500/30' 
                                                : 'bg-transparent border-transparent hover:bg-slate-800'
                                            } ${isOffline ? 'opacity-50 grayscale' : ''}`}
                                        >
                                            <div className={`w-10 h-10 rounded bg-slate-800 flex items-center justify-center shrink-0 overflow-hidden ${isSelected ? 'ring-1 ring-blue-500' : ''}`}>
                                                {channel.logo ? (
                                                    <img src={channel.logo} alt="" className="w-full h-full object-contain p-0.5" onError={(e) => e.currentTarget.style.display = 'none'} />
                                                ) : (
                                                    <span className="text-xs font-bold text-slate-500">{channel.name.slice(0, 2).toUpperCase()}</span>
                                                )}
                                            </div>
                                            
                                            <div className="flex-1 min-w-0 flex flex-col justify-center gap-0.5">
                                                <h3 className={`text-sm font-medium truncate leading-tight ${isSelected ? 'text-blue-400' : 'text-slate-200 group-hover:text-white'} ${isOffline ? 'line-through decoration-slate-600 text-slate-500' : ''}`}>
                                                    {channel.name}
                                                </h3>
                                                <p className="text-[10px] text-slate-500 truncate">{channel.group}</p>
                                            </div>

                                            <div className="flex items-center gap-1 shrink-0">
                                                 <div className="flex items-center justify-center w-6 h-6" title={`状态: ${status}`}>
                                                    {getStatusIcon(status)}
                                                 </div>

                                                 <button 
                                                    onClick={(e) => handleCopy(e, channel)}
                                                    className="p-1.5 rounded-full hover:bg-slate-700 text-slate-500 hover:text-blue-400 transition-colors"
                                                    title="复制 M3U 格式"
                                                 >
                                                    {copiedId === channel.id ? <Check className="w-4 h-4 text-emerald-500" /> : <Copy className="w-4 h-4" />}
                                                 </button>

                                                 <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onToggleFavorite(channel);
                                                    }}
                                                    className={`p-1.5 rounded-full hover:bg-slate-700 transition-colors ${isFavorite ? 'text-yellow-500' : 'text-slate-500 hover:text-yellow-500'}`}
                                                >
                                                    <Star className={`w-4 h-4 ${isFavorite ? 'fill-current' : ''}`} />
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            {visibleCount < filteredChannels.length && (
                                 <div className="py-4 flex justify-center">
                                    <Loader2 className="w-5 h-5 text-slate-500 animate-spin" />
                                 </div>
                            )}
                        </div>
                        
                        <div className="p-2 border-t border-slate-800 text-center bg-slate-950">
                            <p className="text-[10px] text-slate-600">
                                显示 {Math.min(visibleCount, filteredChannels.length)} / {filteredChannels.length} 频道
                            </p>
                        </div>
                    </div>
                </>
            );
        };

        // --- 4. 主应用逻辑 (App) ---

        const DEFAULT_SOURCES = [
          
          { name: '城市综合', url: 'https://raw.githubusercontent.com/vbskycn/iptv/master/tv/iptv4.m3u' },
          { name: '浙江综合', url: 'https://raw.githubusercontent.com/suxuang/myIPTV/refs/heads/main/ipv6.m3u' },
          { name: '浙江卫视', url: 'https://raw.githubusercontent.com/maitel2020/iptv-self-use/main/iptv.m3u' },
          { name: '世界综合', url: 'https://freetv.fun/test_channels_new.m3u' },
          { name: '泰国1', url: 'https://freetv.fun/test_channels_thailand_new.m3u' },
          { name: '泰国2', url: 'https://akkradet.github.io/IPTV-THAI/FREETV.m3u' },
          { name: '泰国3', url: 'https://iptv-org.github.io/iptv/languages/tha.m3u' },
          { name: '台湾', url: 'https://iptv-org.github.io/iptv/countries/tw.m3u' },
          { name: '港澳台', url: 'https://raw.githubusercontent.com/jisoypub/iptv/main/ipv4_2.m3u' }
        ];

        const FAVORITES_KEY = 'iptv_favorites_v1';
        const PLAYLISTS_KEY = 'iptv_playlists_v1';

        const App = () => {
            const [playlists, setPlaylists] = useState(() => {
                const saved = localStorage.getItem(PLAYLISTS_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
                // 如果没有保存的记录，使用默认源
                return DEFAULT_SOURCES.map((src, index) => ({
                    id: `def-${index}`,
                    name: src.name,
                    url: src.url,
                    active: true
                }));
            });

            useEffect(() => { localStorage.setItem(PLAYLISTS_KEY, JSON.stringify(playlists)); }, [playlists]);

            const addPlaylist = (name, url) => {
                setPlaylists(prev => [...prev, { id: `pl-${Date.now()}`, name, url, active: true }]);
            };
            const removePlaylist = (id) => {
                setPlaylists(prev => prev.filter(p => p.id !== id));
            };
            const togglePlaylist = (id) => {
                setPlaylists(prev => prev.map(p => p.id === id ? { ...p, active: !p.active } : p));
            };

            const [channels, setChannels] = useState([]);
            const [favorites, setFavorites] = useState(() => {
                try {
                    const saved = localStorage.getItem(FAVORITES_KEY);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });
            const [selectedChannel, setSelectedChannel] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [online, setOnline] = useState(navigator.onLine);
            const [channelStatuses, setChannelStatuses] = useState({});
            const [isChecking, setIsChecking] = useState(false);
            const abortControllerRef = useRef(null);

            useEffect(() => { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites)); }, [favorites]);

            const toggleFavorite = (channel) => {
                setFavorites(prev => {
                    const exists = prev.some(f => f.url === channel.url);
                    if (exists) return prev.filter(f => f.url !== channel.url);
                    return [...prev, channel];
                });
            };

            const checkConnectivity = async (channelsToCheck) => {
                if (isChecking && abortControllerRef.current) abortControllerRef.current.abort();
                setIsChecking(true);
                abortControllerRef.current = new AbortController();
                const mainSignal = abortControllerRef.current.signal;
                const BATCH_SIZE = 12; 
                const TIMEOUT_MS = 2500;

                const checkUrl = async (url, id) => {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
                        const response = await fetch(url, { method: 'GET', signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (response.ok) return { id, status: 'online' };
                        return { id, status: 'offline' };
                    } catch (e) { return { id, status: 'offline' }; }
                };

                const processBatch = async (batch) => {
                    setChannelStatuses(prev => {
                        const next = { ...prev };
                        batch.forEach(c => next[c.id] = 'testing');
                        return next;
                    });
                    const promises = batch.map(c => checkUrl(c.url, c.id));
                    const results = await Promise.all(promises);
                    if (mainSignal.aborted) return;
                    setChannelStatuses(prev => {
                        const next = { ...prev };
                        results.forEach(r => next[r.id] = r.status);
                        return next;
                    });
                };

                try {
                    // 去重，避免重复检测
                    const uniqueChannels = Array.from(new Map(channelsToCheck.map(item => [item.url, item])).values());
                    for (let i = 0; i < uniqueChannels.length; i += BATCH_SIZE) {
                        if (mainSignal.aborted) break;
                        const batch = uniqueChannels.slice(i, i + BATCH_SIZE);
                        await processBatch(batch);
                    }
                } finally {
                    setIsChecking(false);
                    abortControllerRef.current = null;
                }
            };

            useEffect(() => {
                const handleOnline = () => setOnline(true);
                const handleOffline = () => setOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                const loadChannels = async () => {
                    setLoading(true);
                    setError(null);
                    setChannels([]);
                    try {
                        const activePlaylists = playlists.filter(p => p.active);
                        if (activePlaylists.length === 0) {
                            setLoading(false);
                            return;
                        }
                        const promises = activePlaylists.map(playlist => 
                            fetchAndParsePlaylist(playlist.url)
                                .then(items => items.map(item => ({
                                    ...item,
                                    // 加上 playlist ID 前缀防止冲突
                                    id: `${playlist.id}-${item.id}`,
                                })))
                                .catch(err => {
                                    console.warn(`无法加载播放列表: ${playlist.name}`, err);
                                    return []; 
                                })
                        );
                        const results = await Promise.all(promises);
                        const mergedChannels = results.flat();
                        setChannels(mergedChannels);
                        const allChannelsToCheck = [...favorites, ...mergedChannels];
                        if (allChannelsToCheck.length > 0) checkConnectivity(allChannelsToCheck);
                    } catch (err) {
                        setError("无法加载频道列表，请检查网络设置。");
                    } finally {
                        setLoading(false);
                    }
                };
                loadChannels();
                const handleResize = () => {
                    if (window.innerWidth < 768) setSidebarOpen(false);
                    else setSidebarOpen(true);
                };
                handleResize(); 
                window.addEventListener('resize', handleResize);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    if (abortControllerRef.current) abortControllerRef.current.abort();
                };
            }, [playlists]);

            const groups = useMemo(() => extractGroups(channels), [channels]);
            const handleChannelError = () => {
                if (selectedChannel) setChannelStatuses(prev => ({ ...prev, [selectedChannel.id]: 'offline' }));
            };
            const handleChannelSuccess = () => {
                if (selectedChannel) setChannelStatuses(prev => ({ ...prev, [selectedChannel.id]: 'online' }));
            };

            return (
                <div className="flex h-screen w-screen bg-black text-slate-200 overflow-hidden relative selection:bg-blue-500/30">
                    <ChannelList 
                        channels={channels}
                        groups={groups}
                        favorites={favorites}
                        selectedChannel={selectedChannel}
                        onSelectChannel={setSelectedChannel}
                        onToggleFavorite={toggleFavorite}
                        isOpen={sidebarOpen}
                        setIsOpen={setSidebarOpen}
                        channelStatuses={channelStatuses}
                        onCheckConnectivity={checkConnectivity}
                        isChecking={isChecking}
                        playlists={playlists}
                        onAddPlaylist={addPlaylist}
                        onRemovePlaylist={removePlaylist}
                        onTogglePlaylist={togglePlaylist}
                        onUpdateSource={() => {}} 
                    />

                    <div className="flex-1 flex flex-col relative min-w-0">
                        {!sidebarOpen && (
                             <div className="absolute top-0 left-0 right-0 z-20 p-4 pointer-events-none flex justify-between">
                                <button 
                                    onClick={() => setSidebarOpen(true)}
                                    className="pointer-events-auto p-2 bg-slate-900/80 backdrop-blur-md text-white rounded-lg shadow-lg border border-slate-700 hover:bg-slate-800 transition-colors md:hidden"
                                >
                                    <Menu size={20} strokeWidth={2} />
                                </button>
                             </div>
                        )}

                        <div className="flex-1 relative bg-black shadow-2xl z-0">
                            {loading ? (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/90">
                                    <Loader2 className="w-10 h-10 animate-spin text-blue-500 mb-4" />
                                    <p className="text-slate-500 font-medium">正在加载频道列表...</p>
                                </div>
                            ) : error ? (
                                <div className="absolute inset-0 flex flex-col items-center justify-center text-rose-400 p-8 text-center bg-black/90">
                                    <div className="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center mb-4">
                                        <WifiOff className="w-8 h-8 text-slate-500" />
                                    </div>
                                    <h2 className="text-xl font-bold mb-2 text-white">连接失败</h2>
                                    <p className="mb-6 text-slate-400">{error}</p>
                                    <button 
                                        onClick={() => window.location.reload()} 
                                        className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors font-medium"
                                    >
                                        重新加载
                                    </button>
                                </div>
                            ) : (
                                <VideoPlayer 
                                    url={selectedChannel?.url || null} 
                                    poster={selectedChannel?.logo}
                                    channelName={selectedChannel?.name}
                                    onError={handleChannelError}
                                    onSuccess={handleChannelSuccess}
                                />
                            )}
                        </div>

                        {!online && (
                            <div className="absolute top-0 left-0 right-0 bg-red-600 text-white text-xs text-center py-1.5 z-50 font-bold tracking-wide shadow-md">
                                网络已断开
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
